<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respostas - Violão Depois dos 40</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(100, 181, 246, 0.3);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        #searchInput {
            padding: 15px 20px;
            width: 400px;
            border-radius: 25px;
            border: 2px solid transparent;
            background: #4682b4; /* Azul mais claro */
            color: #fff;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        #searchInput:focus {
            outline: none;
            border: 2px solid #64b5f6;
            box-shadow: 0 0 20px rgba(100, 181, 246, 0.3);
        }
        #searchInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .table-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: top;
        }

        td {
            background: rgba(255,255,255,0.02);
            transition: all 0.3s ease;
        }
        th {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
        }
        tr:hover td {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.01);
        }

        .delete-btn {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: linear-gradient(45deg, #ff3838, #ff2f2f);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .pagination button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        .pagination button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .error-message {
            text-align: center;
            color: #ff6b35;
            margin-top: 20px;
        }
        .info-badge {
            display: inline-block;
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }

        .level-badge {
            background: linear-gradient(45deg, #2196f3, #64b5f6);
        }

        .music-badge {
            background: linear-gradient(45deg, #ff9800, #ffb74d);
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            table, th, td {
                font-size: 12px;
                padding: 10px 8px;
            }
            
            #searchInput {
                width: 100%;
                font-size: 14px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .table-container {
                padding: 15px;
                overflow-x: auto;
            }
            
            .delete-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            animation: fadeIn 0.8s ease-out;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Respostas dos Inscritos</h1>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Buscar por nome ou WhatsApp">
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalResponses">0</div>
                <div class="stat-label">Total de Respostas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayResponses">0</div>
                <div class="stat-label">Hoje</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="weekResponses">0</div>
                <div class="stat-label">Esta Semana</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgAge">0</div>
                <div class="stat-label">Idade Média</div>
            </div>
        </div>

        <div class="table-container">
            <table id="responsesTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>WhatsApp</th>
                        <th>Idade</th>
                        <th>Nível no Violão</th>
                        <th>Tipo de Música</th>
                        <th>Informações Adicionais</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="pagination">
            <button id="prevPage" disabled>Anterior</button>
            <button id="nextPage">Próximo</button>
        </div>
        <div class="error-message" id="errorMessage"></div>

        <div class="levels-container" style="display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
            <div class="level-card" style="background: linear-gradient(135deg, rgba(100, 181, 246, 0.2), rgba(100, 181, 246, 0.1)); border-radius: 10px; padding: 15px; text-align: center; min-width: 200px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease;">
                <p style="color: #2196f3; font-size: 18px; margin: 0 0 5px 0; font-weight: bold;">Zero</p>
                <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 5px;">Não sabe nada</p>
            </div>
            <div class="level-card" style="background: linear-gradient(135deg, rgba(100, 181, 246, 0.2), rgba(100, 181, 246, 0.1)); border-radius: 10px; padding: 15px; text-align: center; min-width: 200px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease;">
                <p style="color: #2196f3; font-size: 18px; margin: 0 0 5px 0; font-weight: bold;">Iniciante</p>
                <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 5px;">Sabe algo, mas não toca música inteira com segurança</p>
            </div>
            <div class="level-card" style="background: linear-gradient(135deg, rgba(100, 181, 246, 0.2), rgba(100, 181, 246, 0.1)); border-radius: 10px; padding: 15px; text-align: center; min-width: 200px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease;">
                <p style="color: #2196f3; font-size: 18px; margin: 0 0 5px 0; font-weight: bold;">Intermediário</p>
                <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 5px;">Toca pelo menos uma música inteira com segurança</p>
            </div>
        </div>

    </div>

    <script>
    const API_URL = 'https://lively-hall-dce9.suportegabriel7.workers.dev/inscricoes';
    const itemsPerPage = 10;
    let currentPage = 1;
    let allData = [];

    async function loadData() {
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            console.log('Dados recebidos:', result);
            allData = result.success && Array.isArray(result.data) ? result.data : [];
            if (allData.length === 0) {
                document.getElementById('errorMessage').textContent = 'Nenhum dado encontrado.';
            }
            updateStats();
            displayData();
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            document.getElementById('errorMessage').textContent = 'Erro ao carregar dados. Tente novamente.';
        }
    }

    function updateStats() {
        const total = allData.length;
        const today = new Date().toDateString();
        const todayCount = allData.filter(item => {
            if (!item.createdAt) return false;
            return new Date(item.createdAt).toDateString() === today;
        }).length;
        
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const weekCount = allData.filter(item => {
            if (!item.createdAt) return false;
            return new Date(item.createdAt) >= weekAgo;
        }).length;
        
        const ages = allData.filter(item => item.idade && !isNaN(item.idade))
                            .map(item => parseInt(item.idade));
        const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;
        
        document.getElementById('totalResponses').textContent = total;
        document.getElementById('todayResponses').textContent = todayCount;
        document.getElementById('weekResponses').textContent = weekCount;
        document.getElementById('avgAge').textContent = avgAge || '-';
    }

    function displayData() {
        allData.sort((a, b) => new Date(b.data_inscricao) - new Date(a.data_inscricao));
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredData = allData.filter(item => {
            try {
                return (
                    (item.nome?.toLowerCase()?.includes(searchTerm) || false) ||
                    (item.whatsapp?.includes(searchTerm) || false)
                );
            } catch (e) {
                return false;
            }
        });

    

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedData = filteredData.slice(start, end);

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = paginatedData.map(item => {
            const isInvalid = typeof item.dados_pessoais_name === 'undefined' && typeof item.dados_pessoais === 'string';
            
            const levelMap = {
                'zero': 'Zero',
                'iniciante': 'Iniciante',
                'intermediario': 'Intermediário',
                'personalizado': 'Personalizado'
            };
            const extraMap = {
                'sim': 'Sim',
                'nao': 'Não'
            };
            const formatWhatsApp = (number) => {
                if (!number) return '';
                let cleanNumber = number.replace(/\D/g, '');
                if (cleanNumber.length === 10) {
                    cleanNumber = `${cleanNumber.slice(0, 2)}9${cleanNumber.slice(2)}`;
                }
                if (cleanNumber.length === 11) {
                    const ddd = cleanNumber.slice(0, 2);
                    const firstPart = cleanNumber.slice(2, 7);
                    const secondPart = cleanNumber.slice(7);
                    return `+55 (${ddd}) ${firstPart}-${secondPart}`;
                }
                return cleanNumber;
            };
            const levelText = isInvalid ? '-' : (item.nivel_violao ? levelMap[item.nivel_violao] || item.nivel_violao.charAt(0).toUpperCase() + item.nivel_violao.slice(1) : '-');
            const customLevel = item.nivel_personalizado ? `<br><small style="color: #64b5f6;">${item.nivel_personalizado.charAt(0).toUpperCase() + item.nivel_personalizado.slice(1)}</small>` : '';

            const musicMap = {
                'sertaneja': 'Sertaneja',
                'brega': 'Brega',
                'catolica': 'Católica',
                'evangelica': 'Evangélica',
                'outro': 'Outro'
            };
            const musicText = isInvalid ? '-' : (item.tipo_musica ? musicMap[item.tipo_musica] || item.tipo_musica.charAt(0).toUpperCase() + item.tipo_musica.slice(1) : '-');
            const otherMusic = item.musica_personalizada ? `<br><small style="color: #64b5f6;">${item.musica_personalizada.charAt(0).toUpperCase() + item.musica_personalizada.slice(1)}</small>` : '';
            
            return `
                <tr style="animation: fadeIn 0.5s ease-in;">
                    <td><strong>${isInvalid ? '-' : (item.nome || '-')}</strong></td>
                    <td>${isInvalid ? '-' : (item.whatsapp ? `<a href="whatsapp://send?phone=+55${item.whatsapp.replace(/\D/g, '')}" style="color: #64b5f6; text-decoration: none;" target="_self">${formatWhatsApp(item.whatsapp)}</a>` : '-')}</td>
                    <td>${isInvalid ? '-' : (item.idade || '-')} anos</td>
                    <td>${levelText}${customLevel}</td>
                    <td>${musicText}${otherMusic}</td>
                    <td style="max-width: 200px; word-wrap: break-word;">${isInvalid ? '-' : (item.mais_informacoes ? extraMap[item.mais_informacoes] || item.mais_informacoes.charAt(0).toUpperCase() + item.mais_informacoes.slice(1) : '-')}${item.texto_extra ? `<br><small style="color: #64b5f6;">${item.texto_extra.charAt(0).toUpperCase() + item.texto_extra.slice(1)}</small>` : ''}</td>
                    <td>${item.data_inscricao ? new Date(item.data_inscricao).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '-'}</td>
                    <td><button class="delete-btn" onclick="deleteResponse('${item.id}')">🗑️ Excluir</button></td>
                </tr>
            `;
        }).join('');

        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = end >= filteredData.length;
        document.getElementById('errorMessage').textContent = filteredData.length === 0 && allData.length > 0 ? 'Nenhum resultado para a busca.' : '';
    }

    async function deleteResponse(id) {
        if (!confirm('Tem certeza que deseja apagar esta resposta?')) return;
        try {
            const response = await fetch(`${API_URL}/${id}?method=1`, {
                method: 'DELETE'
            });
            if (response.ok) {
                document.getElementById('errorMessage').textContent = 'Resposta apagada com sucesso!';
                await loadData();
            } else {
                document.getElementById('errorMessage').textContent = 'Erro ao apagar resposta.';
            }
        } catch (error) {
            console.error('Erro ao apagar:', error);
            document.getElementById('errorMessage').textContent = 'Erro ao apagar resposta. Tente novamente.';
        }
    }

    document.getElementById('searchInput').addEventListener('input', () => {
        currentPage = 1;
        displayData();
    });

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            displayData();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        displayData();
    });

    loadData();
    </script>
</body>
</html>
